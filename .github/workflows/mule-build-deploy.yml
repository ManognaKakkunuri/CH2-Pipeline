name: Build & Deploy Mule 4.9 App to CloudHub 2.0

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: Checkout Code
        uses: actions/checkout@v3

      # Setup JDK 17
      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17

      # Build Mule 4.9 app
      - name: Build Mule App
        run: mvn clean package

      # Run MUnit tests
      - name: Run MUnit Tests
        run: mvn test -Dmunit

      # Install Anypoint CLI v4
      - name: Install Anypoint CLI
        run: npm install -g anypoint-cli-v4

      # Login to Anypoint Platform
      - name: Anypoint Login
        run: |
          anypoint-cli-v4 auth:login \
            --username "$ANYPOINT_USERNAME" \
            --password "$ANYPOINT_PASSWORD"
        env:
          ANYPOINT_USERNAME: ${{ secrets.ANYPOINT_USERNAME }}
          ANYPOINT_PASSWORD: ${{ secrets.ANYPOINT_PASSWORD }}

      # Deploy to CloudHub 2.0
      - name: Deploy to CloudHub 2.0
        run: |
          anypoint-cli-v4 runtime-mgr-2 deploy-cloudhub-2 \
            --artifact target/*.jar \
            --application-name my-mule-app \
            --environment-id "$ANYPOINT_ENV_ID" \
            --organization-id "$ANYPOINT_ORG_ID" \
            --region "$CH2_REGION" \
            --runtime-version 4.9.0 \
            --replicas 1 \
            --cpu 0.1 \
            --memory 0.2 \
            --force
        env:
          ANYPOINT_ENV_ID: ${{ secrets.ANYPOINT_ENV_ID }}
          ANYPOINT_ORG_ID: ${{ secrets.ANYPOINT_ORG_ID }}
          CH2_REGION: ${{ secrets.CH2_REGION }}
